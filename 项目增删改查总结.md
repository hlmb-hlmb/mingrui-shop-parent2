## 分类管理

新建JSONUtil 处理日期格式和 获取json需要的值

新建HTTPStatus成功回调函数 和失败回调函数

```
public class HTTPStatus {
public static final int OK = 200;//成功
public static final int ERROR = 500;//失败
}
```

新建Result

```
@Data
@NoArgsConstructor
public class Result<T> {
    private Integer code;//返回码
    private String message;//返回消息
    private T data;//返回数据
    public Result(Integer code, String message, Object data) {
    this.code = code;
    this.message = message;
    this.data = (T) data;
    }
}

```

BaseApiService 返回成功的传的值

```
@Data
@Component
@Slf4j
public class BaseApiService<T> {
    public Result<T> setResultError(Integer code, String msg) {
    return setResult(code, msg, null);
    }
    // 返回错误，可以传msg
    public Result<T> setResultError(String msg) {
    return setResult(HTTPStatus.ERROR, msg, null);
    }
    // 返回成功，可以传data值
    public Result<T> setResultSuccess(T data) {
    return setResult(HTTPStatus.OK, HTTPStatus.OK + "", data);
    }
    // 返回成功，沒有data值
    public Result<T> setResultSuccess() {
    return setResult(HTTPStatus.OK, HTTPStatus.OK + "", null);
    }
    // 返回成功，沒有data值
    public Result<T> setResultSuccess(String msg) {
    return setResult(HTTPStatus.OK, msg, null);
    }
    // 通用封装
    public Result<T> setResult(Integer code, String msg, T data) {
    log.info(String.format("{code : %s , msg : %s , data : %s}",code,msg,
    JSONUtil.toJsonString(data)));
    return new Result<T>(code, msg, data);
    }
}

```

新建 CategoryEntity实体类 

```
@ApiModel(value = "分类实体类")
@Data
@Table(name = "tb_category")
public class CategoryEntity {
    @Id
    @ApiModelProperty(value = "分类主键",example = "1")
    private Integer id;
    @ApiModelProperty(value = "分类名称")
    private String name;
    @ApiModelProperty(value = "父级分类",example = "1")
    private Integer parentId;
    @ApiModelProperty(value = "是否是父级节点",example = "1")
    private Integer isParent;
    @ApiModelProperty(value = "排序",example = "1")
    private Integer sort;
}

```

定义分类管理 CategoryService的接口

```
public interface CategoryService 

    @ApiOperation(value = "通过查询商品分类")
    @GetMapping(value = "category/list")
    Result<List<CategoryEntity>> getCategoryByPid(Integer pid);
}
```

CategoryServiceImpl

查询

```
List<CategoryEntity>list = categoryMapper.getCategoryByBrandId(brandId);
return this.setResultSuccess(list);
```

删除

在v-tree组件中绑定一个key的属性,默认值为0

```
<v-tree :key="key" url="/category/list">
    data() {
    return {
   		key:0
    }
}
```

在CategoryService写删除接口

```js
 public Result<Object> saveCategory(CategoryEntity categoryEntity) {
//        if (categoryEntity.getIsParent() != 1){
//            CategoryEntity cate = new CategoryEntity();
//            cate.setIsParent(1);
//            categoryMapper.updateByPrimaryKeySelective(cate);
//        }

        CategoryEntity cate = new CategoryEntity();
        cate.setId(categoryEntity.getParentId());
        cate.setIsParent(1);
        categoryMapper.updateByPrimaryKeySelective(cate);

        categoryMapper.insertSelective(categoryEntity);
        return this.setResultSuccess();
    }
```

//新增

Category查询出来是树状图的,有父子叶结构,要在某个节点下添加一个子节点,那么改节点必须是父节点状态( Is_Parent字段控制着节点状态,1为父节点状态,0为子节点状态也就是在它下面没有叶节点 )

所以第一步就是把改数据的IsParent设置为1

前台点击新增会传来一个 name="新的节点"	parentId为点击创建节点id 的一个数据

new一个新的对象,把id设置为parentId,isParent设置为1,进行父类状态的修改

然后新增数据传来的数据

```js
   @Transactional//事务
    @Override//新增
    public Result<Object> saveCategory(CategoryEntity categoryEntity) {
//        if (categoryEntity.getIsParent() != 1){
//            CategoryEntity cate = new CategoryEntity();
//            cate.setIsParent(1);
//            categoryMapper.updateByPrimaryKeySelective(cate);
//        }
           CategoryEntity cate = new CategoryEntity();
            cate.setId(categoryEntity.getParentId());
            cate.setIsParent(1);
            categoryMapper.updateByPrimaryKeySelective(cate);

            categoryMapper.insertSelective(categoryEntity);
            return this.setResultSuccess();//调用返回成功方法,不用传参数
}
```
修改 只修改本身就可以了

```js
 @Transactional
    @Override//修改
    public Result<Object> editCategory(CategoryEntity categoryEntity) {
        categoryMapper.updateByPrimaryKeySelective(categoryEntity);
        return this.setResultSuccess();//调用返回成功方法,不用传参数
    }
```



## 品牌管理

前台 vue创建在item中新建Mrbrand.vue

```
<template>
  <v-card>
    <v-card-title>
      <v-btn color="info">新增</v-btn>
      <!-- 调按钮和输入框之间的间距 -->
      <v-spacer />
      <!--
            append-icon : 图标
            label : input默认值
        -->
      <v-text-field
        append-icon="search"
        label="品牌名称"
        @keyup.enter="getTableData()"
        v-model="search"
      ></v-text-field>
    </v-card-title>
    <!-- 表格组件 -->
        <!-- :pagination.sync="pagination" 绑定分页属性,并将分页参数绑定给data.pagination
        -->
        <!-- :total-items="total" 设置总条数,获取data.total中的值 -->
    <v-data-table
      :headers="headers"
      :items="desserts"
      :pagination.sync="pagination"
      :total-items="total"
      class="elevation-1"
    >
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.name }}</td>
        <td class="text-xs-center">
          <!-- src 是html标签的属性 :src="vue的属性" -->
          <img :src="props.item.image" />
        </td>
        <td class="text-xs-center">{{ props.item.letter }}</td>
      </template>
    </v-data-table>
  </v-card>
</template>
<script>
export default {
  name: "MrBrand",//组件的名称
  data() {
    return {
      pagination: {},//分页参数信息
      total: 0,//总条数,初始值为0
      search: "",
      headers: [
        {
          text: "id",
          align: "center",
          value: "id",
        },
        {
          text: "品牌名称",
          align: "center",
          value: "name",
        },
        {
          text: "品牌logo",
          align: "center",
          value: "image",
        },
        {
          text: "首字母",
          align: "center",
          value: "letter",
        },
      ],
      desserts: [],//数据
    };
  },
    //组件加载完毕后执行的方法
  mounted() {
    this.getTableData();//查询方法,刷新列表
  },
  methods: {
    getTableData() {
      this.$http
        .get("/brand/list", {
          //查询传递的参数
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            name: this.search
          },
        })
        .then((resp) => {
          //给数据属性赋值
          this.desserts = resp.data.data.list;
          //给总条数赋值
          this.total = resp.data.data.total;
        })
        .catch((error) => console.log(error));
    }
  },
  watch: {//监控属性
    pagination() {//监控分页属性的变化
      this.getTableData();//刷新列表
    }
  }
};
</script>
```

更改index.js 27行

```
route("/item/brand",'/item/MrBrand',"MrBrand"),
```

### 商品管理 查询

让后在后台写接口

```js
@ApiOperation(value = "获取品牌信息")
@GetMapping(value = "brand/list")
public Result<PageInfo<BrandEntity>> list(BrandDTO brandDTO);
```

先整理排序 写工具类BeasDTO  调用工具类写出排序和分页 然后模糊查询  

```
@Override
public Result<PageInfo<BrandEntity>> list(BrandDTO brandDTO) {

    //排序
    PageHelper.startPage(brandDTO.getPage(),brandDTO.getRows());

    if(!StringUtils.isEmpty(brandDTO.getSort())) PageHelper.orderBy(brandDTO.getOrderBy());

    BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO,BrandEntity.class);
    //模糊查询
    Example example = new Example(BrandEntity.class);
    example.createCriteria().andLike("name","%" + brandEntity.getName() + "%");

    List<BrandEntity> brandEntities = brandMapper.selectByExample(example);
    PageInfo<BrandEntity> pageInfo = new PageInfo<>(brandEntities);

    return this.setResultSuccess(pageInfo);
}
```

### 商品管理新增

前台新建MrBrandForm.vue

```
<template>
  <div>
    <v-card-text>
      <v-form v-model="valid" ref="form">
        <v-text-field
          v-model="brand.name"
          label="品牌名称"
          :rules="nameRules"
          required
        ></v-text-field>
		//查询分类信息
        <v-cascader
          url="/category/list"
          required
          v-model="brand.categories"
          multiple
          label="商品分类"
        />

        <v-layout row>
          <v-flex xs3>
            <span style="font-size: 16px; color: #444">品牌LOGO：</span>
          </v-flex>
          <v-flex>
            <v-upload
              v-model="brand.image"
              url="/upload"
              :multiple="false"
              :pic-width="250"
              :pic-height="90"
            />
          </v-flex>
        </v-layout>
      </v-form>
    </v-card-text>

    <v-divider></v-divider>

    <v-card-actions>
      <v-spacer></v-spacer>
      <v-btn small @click="cancel()">取消</v-btn>
      <v-btn small color="primary" @click="submitForm()">确认</v-btn>
    </v-card-actions>
  </div>
</template>
<script>
export default {
  name: "MrBrandForm",
  props: {
    dialog: Boolean,//模态框状态设置为boolean类型
  },
  watch: {
    dialog(val) {
      if (val) this.$refs.form.reset();
    },
  },
  data() {
    //在js中 null == false , '' == false , undefined == false , 0 == false
    return {
      valid: true,
      nameRules: [
        (v) => !!v || "品牌名称不能为空",
        (v) => (v && v.length <= 10) || "品牌名称最多10个长度",
      ],
      brand: {
        name: "",
        image:'',
        categories: [],
      },
    };
  },
  methods: {
    cancel() {
      this.$emit("closeDialog");
    },
    submitForm() {
      if (!this.$refs.form.validate()) {
        return;
      }
      let formData = this.brand;
      let categoryIdArr = this.brand.categories.map((category) => category.id);
      formData.categories = categoryIdArr.join();

      this.$http
        .post("/brand/save", formData)
        .then((resp) => {
          if (resp.data.code != 200) {
            return;
          }
          //关闭模态框
          this.cancel();
          //刷新表单
        })
        .catch((error) => console.log(error));
    },
  },
};
</script>
```

在在MrBrand中添加新增属性

```
<template>
  <v-card>
    <v-card-title>
      <v-btn color="info" @click="dialog = true">新增</v-btn>//点击新增按钮打开模态框

      <div class="text-xs-center">
    <v-dialog
      v-model="dialog"
      width="500"
    >
      <v-card>
        <v-card-title
          class="headline grey lighten-2"
          primary-title
        >
          品牌新增
        </v-card-title>

        <mr-brand-form @closeDialog="dialog = false" :dialog="dialog"/>

      </v-card>
    </v-dialog>
  </div>

      <!-- 调按钮和输入框之间的间距 -->
      <v-spacer />

      <!--
            append-icon : 图标
            label : input默认值
        -->
      <v-text-field
        append-icon="search"
        label="品牌名称"
        @keyup.enter="getTableData()"
        v-model="search"
      ></v-text-field>
    </v-card-title>
    <!-- 表格组件 -->
    <v-data-table
      :headers="headers"
      :items="desserts"
      :pagination.sync="pagination"
      :total-items="total"
      class="elevation-1"
    >
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.name }}</td>
        <td class="text-xs-center">
          <!-- src 是html标签的属性 :src="vue的属性" -->
          <img :src="props.item.image" />
        </td>
        <td class="text-xs-center">{{ props.item.letter }}</td>
      </template>
    </v-data-table>
  </v-card>
</template>
<script>
import MrBrandForm from './MrBrandForm';
export default {
  name: "MrBrand",
  components:{
    MrBrandForm
  },
  data() {
    return {
      pagination: {},
      dialog: false,
      total: 0,
      search: "",
      headers: [
        {
          text: "id",
          align: "center",
          value: "id",
        },
        {
          text: "品牌名称",
          align: "center",
          value: "name",
        },
        {
          text: "品牌logo",
          align: "center",
          value: "image",
        },
        {
          text: "首字母",
          align: "center",
          value: "letter",
        },
      ],
      desserts: [],
    };
  },
  mounted() {
    this.getTableData();
  },
  methods: {
    getTableData() {

      this.$http
        .get("/brand/list", {
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            name: this.search
          },
        })
        .then((resp) => {
          this.desserts = resp.data.data.list;
          this.total = resp.data.data.total;
        })
        .catch((error) => console.log(error));
    }
  },
  watch: {
    pagination() {
      this.getTableData();
    }
  }
};
</script>
```

整理前台vue  然后写出接口

```js
@ApiOperation(value = "查询商品列表")
    @PostMapping(value = "brand/save")
    public Result<JSONObject> saveBrandInfo(@RequestBody  BrandDTO brandDTO);
```

增删改必须要写@Transactional  保证全部成功 要么就回滚一条也成功不了 才能保证数据的准确性

也是同样的写一个BaiduBeanUtil工具类 用来调用 还有PinyinUtil工具类来调用处理品牌首字母

维护中间表数据 也就是 商品分类的表 不然会出错

```js
 @Transactional
    @Override
    public Result<JSONObject> saveBrandInfo(BrandDTO brandDTO) {

        //新增返回主键?
        //两种方式实现 select-key insert加两个属性
        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO, BrandEntity.class);
        //处理品牌首字母
        brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]), false).toCharArray()[0]);

        brandMapper.insertSelective(brandEntity);

        //维护中间表数据
        this.insertCategoryBrandList(brandDTO.getCategories(),brandEntity.getId());

        return this.setResultSuccess();
    }
```



### 商品管理修改

整理vue 

```
<template>
  <v-card>
    <v-card-title>
      <v-btn color="info" @click="addData()">新增</v-btn>

      <div class="text-xs-center">
        <v-dialog v-model="dialog" width="500">
          <v-card>
            <v-card-title class="headline grey lighten-2" primary-title>
              品牌{{ isEdit?'修改':'新增' }}
            </v-card-title>

            <mr-brand-form @closeDialog="closeDialog" :dialog="dialog" :isEdit="isEdit" :brandDetail="brandDetail" />
          </v-card>
        </v-dialog>
      </div>

      <!-- 调按钮和输入框之间的间距 -->
      <v-spacer />

      <!--
            append-icon : 图标
            label : input默认值
        -->
      <v-text-field
        append-icon="search"
        label="品牌名称"
        @keyup.enter="getTableData()"
        v-model="search"
      ></v-text-field>
    </v-card-title>
    <!-- 表格组件 -->
    <v-data-table
      :headers="headers"
      :items="desserts"
      :pagination.sync="pagination"
      :total-items="total"
      class="elevation-1"
    >
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.name }}</td>
        <td class="text-xs-center">
          <!-- src 是html标签的属性 :src="vue的属性" -->
          <img width="100" :src="props.item.image" />
        </td>
        <td class="text-xs-center">{{ props.item.letter }}</td>
        <td class="text-xs-center">
          <v-btn flat icon color="green" @click="editData(props.item)">
            <v-icon>edit</v-icon>
          </v-btn>
          <v-btn flat icon color="red" @click="deleteBrand(props.item)">
            <v-icon>delete</v-icon>
          </v-btn>
        </td>
      </template>
    </v-data-table>
  </v-card>
</template>
<script>
import MrBrandForm from "./MrBrandForm";
export default {
  name: "MrBrand",
  components: {
    MrBrandForm,
  },
  data() {
    return {
      brandDetail:{},
      isEdit:false,
      pagination: {},
      dialog: false,
      total: 0,
      search: "",
      headers: [
        {
          text: "id",
          align: "center",
          value: "id",
        },
        {
          text: "品牌名称",
          align: "center",
          value: "name",
        },
        {
          text: "品牌logo",
          align: "center",
          value: "image",
        },
        {
          text: "首字母",
          align: "center",
          value: "letter",
        },
        {
          text: "操作",
          align: "center",
          sortable: false,
          value: "id",
        },
      ],
      desserts: [],
    };
  },
  mounted() {
    this.getTableData();
  },
  methods: {
    closeDialog () {
      this.dialog = false;
      this.getTableData();
    },
    addData () {
      //this.brandDetail = {};
      this.isEdit = false;
      this.dialog = true;
    },
    editData (obj) {
      this.brandDetail = obj;
      this.isEdit = true;
      this.dialog = true;
    },
    getTableData() {
      this.$http
        .get("/brand/list", {
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            name: this.search,
          },
        })
        .then((resp) => {
          this.desserts = resp.data.data.list;
          this.total = resp.data.data.total;
        })
        .catch((error) => console.log(error));
    },
    deleteBrand(item) {
        this.$message.confirm('此操作将永久删除该品牌, 是否继续?').then(() => {
          // 发起删除请求
          this.$http.delete("/brand/delete?id=" + item.id,)
            .then(() => {
              // 删除成功，重新加载数据
              this.$message.success("删除成功！");
              this.getTableData();
            })
        }).catch(() => {
          this.$message.info("删除已取消！");
        });

      },
  },
  watch: {
    pagination() {
      this.getTableData();
    },
  },
};
</script>
```

后台接口

```js
	@PutMapping(value = "brand/save")
    @ApiOperation(value = "修改品牌列表")
    Result<JSONObject> editBrandInfo(@RequestBody BrandDTO brandDTO);

```

修改同样加@Transactional 

处理一下首字母问题

让后删除中间表数据 不然会个之前的数据有冲突

让后写入提取出来的公共新增区域 减少代码的冗余

```js
@Transactional
    @Override
    public Result<JSONObject> editBrandInfo(BrandDTO brandDTO) {
        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO, BrandEntity.class);
        brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]), false).toCharArray()[0]);
        brandMapper.updateByPrimaryKeySelective(brandEntity);

        //先通过brandId删除中间表的数据
        deleteCategoryBrandByBrandId(brandEntity.getId());
        //批量新增 / 新增
        this.insertCategoryBrandList(brandDTO.getCategories(),brandEntity.getId());

        return this.setResultSuccess();
    }
```

### 商品管理删除

在mrBrand.vue中 52行

```
    <v-btn flat icon color="red" @click="deleteBrand(props.item)">
    <v-icon>delete</v-icon>
    </v-btn>
```

在mrBrand.vue中 141行

```
deleteBrand(item) {
        this.$message.confirm('此操作将永久删除该品牌, 是否继续?').then(() => {
          // 发起删除请求
          this.$http.delete("/brand/delete?id=" + item.id,)
            .then(() => {
              // 删除成功，重新加载数据
              this.$message.success("删除成功！");
              this.getTableData();
            })
        }).catch(() => {
          this.$message.info("删除已取消！");
        });
      }
```

整理 vue 写出接口 

```js
@DeleteMapping(value = "brand/delete")
@ApiOperation(value = "删除品牌列表")
Result<JSONObject> deleteBrandInfo(Integer id);
```

正常的删除 

提取删除的公共代码 减少代码的冗余

```js
@Override
    public Result<JSONObject> deleteBrandInfo(Integer id) {
        //删除品牌
        brandMapper.deleteByPrimaryKey(id);
        //删除品牌的分类
            this.deleteCategoryBrandByBrandId(id);
        return this.setResultSuccess();
    }
```



### 公共代码 提取

 		将公共的代码抽取出来
        看是否需要返回值
        看抽取出来的方法是否需要别的类调用
        抽取出来的代码哪里报错,查看报错信息,用方法的参数代替(可变的内容当做方法的参数)
        如果有不重要的返回值代码 --> 手动抛自定义异常(全局异常处理会帮我们处理)

### 新增提取

```js
private void insertCategoryBrandList(String categories, Integer brandId){

        //将公共的代码抽取出来
        //看是否需要返回值
        //看抽取出来的方法是否需要别的类调用
        //抽取出来的代码哪里报错,查看报错信息,用方法的参数代替(可变的内容当做方法的参数)
        //如果有不重要的返回值代码 --> 手动抛自定义异常(全局异常处理会帮我们处理)

        // 自定义异常
        if(StringUtils.isEmpty(categories)) throw new RuntimeException("分类信息不能为空");

        //判断分类集合字符串中是否包含,
        if(categories.contains(",")){//多个分类 --> 批量新增

            categoryBrandMapper.insertList(
                    Arrays.asList(categories.split(","))
                            .stream()
                            .map(categoryIdStr -> new CategoryBrandEntity(Integer.valueOf(categoryIdStr)
                                    ,brandId))
                            .collect(Collectors.toList())
            );

        }else{//普通单个新增

            CategoryBrandEntity categoryBrandEntity = new CategoryBrandEntity();
            categoryBrandEntity.setBrandId(brandId);
            categoryBrandEntity.setCategoryId(Integer.valueOf(categories));

            categoryBrandMapper.insertSelective(categoryBrandEntity);
        }
```

### 删除提取

```js
//删除方法 公用方法
    private void deleteCategoryBrandByBrandId(Integer brandId){
        Example example = new Example(CategoryBrandEntity.class);
        example.createCriteria().andEqualTo("brandId",brandId);
        categoryBrandMapper.deleteByExample(example);
    }
```

## 规格组增删改查

### 修改Vue

首先修改前台页面 VUE 前台

前台代码vue的bug较多

 index.js 29行

```js
route("/item/specification",'/item/specification/Specification',"Specification"),
```

将url地址改为我们分类的管理查询的地址

specification包下Specification.vue

```js
<v-tree url="/category/list" :isEdit="false" @handleClick="handleClick" />
```

修改SpecGroup.vue

```js
loadData(){
    this.$http.get("/specgroup/getSpecGroupInfo",{
   		params:{
			cid:this.cid
		}
	})
	.then((resp) => {
		this.groups = resp.data.data;
	})
	.catch(() => {
		this.groups = [];
	})
},

```

### 后台

  mingrui-shop-service-api-xxx 

  entity包下新建SpecGroupEntity

  dto包下新建SpecGroupDTO

  service包下新建SpecificationService

mapper包下新建SpecGroupMapper

service.impl包下新建SpecificationServiceImpl

查询接口

```js
    @ApiOperation(value = "通过条件查询规格组")
    @GetMapping(value = "/specgroup/getSpecGroupInfo")
    Result<List<SpecGroupEntity>> getSpecGroupInfo(SpecGroupDTO specGroupDTO);
```

```html
@RestController
public class SpecificationServiceImpl extends BaseApiService implements
SpecificationService {
@Resource
private SpecGroupMapper specGroupMapper;
@Override
public Result<List<SpecGroupEntity>> getSepcGroupInfo(SpecGroupDTO specGroupDTO) {
	//通过id查询数据
	Example example = new Example(SpecGroupEntity.class);
        			example.createCriteria().andEqualTo("cid",BaiduBeanUtil.copyProperties(specGroupDTO,SpecGroupEntity.class)
.getCid());
		
        List<SpecGroupEntity> list = specGroupMapper.selectByExample(example);
        	
            return this.setResultSuccess(list);
}
```

### 规格组 新增 修改 删除

前台

SpecGroup.vue 72行

新增

```
save(){
           this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: '/specgroup/save',
            data: this.group
          }).then(() => {
            // 关闭窗口
            this.show = false;
            this.$message.success("保存成功！");
            this.loadData();
          }).catch(() => {
              this.$message.error("保存失败！");
            });
      }
```

修改

```
save(){
           this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: '/specgroup/save',
            data: this.group
          }).then(() => {
            // 关闭窗口
            this.show = false;
            this.$message.success("保存成功！");
            this.loadData();
          }).catch(() => {
              this.$message.error("保存失败！");
            });
      }
```

删除

```
deleteGroup(id){
          this.$message.confirm("确认要删除分组吗？")
          .then(() => {
            this.$http.delete("/specgroup/delete/" + id)
                .then((resp) => {
                    if (resp.data.code != 200) {
                        this.$message.error(resp.data.message);
                        return;
                    }
                    this.$message.success("删除成功");
                    this.loadData();
                })
                .catch(() => {
                    this.$message.error("删除失败");
                    this.loadData();
                })
          })
      }
```

接口

```js
 	@ApiOperation(value = "新增")
    @PostMapping(value = "/specgroup/save")
    Result<JsonObject> saveSpecGroup(@RequestBody SpecGroupDTO specGroupDTO);

    @ApiOperation(value = "修改")
    @PutMapping(value = "/specgroup/save")
    Result<JsonObject> updateSpecGroup(@RequestBody SpecGroupDTO specGroupDTO);

    @ApiOperation(value = "删除")
    @DeleteMapping(value = "/specgroup/delete/{id}")
    Result<JsonObject> deleteSpecGroup(@PathVariable Integer id);
```

Vue中 SpecGroup.vue修改路径

新增

```
specGroupMapper.insertSelective(BaiduBeanUtil.copyProperties(specGroupDTO,SpecGroupEntity.class));
        return this.setResultSuccess();
```

修改

```
specGroupMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(specGroupDTO,SpecGroupEntity.class));
        return this.setResultSuccess();
```

删除 

```
		//判断规格组之前是否有规格参数
		//通过id判断
        Example example = new Example(SpecParamEntity.class);
        example.createCriteria().andEqualTo("groupId",id);

        List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);

        if(specParamEntities.size() > 0){
            return this.setResultError("不能删除此参数");
        }
        specGroupMapper.deleteByPrimaryKey(id);
        return this.setResultSuccess();
```

## 规格参数 增删改查

查询

前台

```
loadData() {
      this.$http
        .get("/specparam/getSpecParamInfo?groupId=" + this.group.id)
        .then((resp) => {
          resp.data.data.forEach(p => {
              p.segments = p.segments ? p.segments.split(",").map(s => s.split("-")) : [];
          })
          this.params = resp.data.data;
        })
        .catch(() => {
          this.params = [];
        });
    }
```

规格参数的接口

```js
	@ApiOperation(value = "通过条件查询规格参数")
    @GetMapping(value = "/specparam/getSpecParamInfo")
    Result<List<SpecParamEntity>> getSpecParamInfo(SpecParamDTO specParamDTO);
```

修改vueSpecParam.vue

```
loadData() {
    this.$http
        .get("specparam/getSpecParamInfo",{
        	params:{
       			 groupId:this.group.id
       		 }
        })
        .then(( resp ) => {
       		 resp.data.data.forEach(p => {
       			 p.segments = p.segments ? p.segments.split(",").map(s => s.split("-")) : [];
        	})
        this.params = resp.data.data;
        })
        .catch(() => {
        this.params = [];
    });
},

```

新增

```
save(){
        const p = {};
        Object.assign(p, this.param);
        p.segments = p.segments.map(s => s.join("-")).join(",")
        this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: '/specparam/save',
            data: p,
        }).then(() => {
            // 关闭窗口
            this.show = false;
            this.$message.success("保存成功！");
            this.loadData();
          }).catch(() => {
              this.$message.error("保存失败！");
            });
    }
```

修改

```
 save(){
        const p = {};
        Object.assign(p, this.param);
        p.segments = p.segments.map(s => s.join("-")).join(",")
        this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: '/specparam/save',
            data: p,
        }).then(() => {
            // 关闭窗口
            this.show = false;
            this.$message.success("保存成功！");
            this.loadData();
          }).catch(() => {
              this.$message.error("保存失败！");
            });
    }
```

删除

```
deleteParam(id) {
        this.$message.confirm("确认要删除该参数吗？")
        .then(() => {
            this.$http.delete("/item/spec/param/" + id)
            .then(() => {
                this.$message.success("删除成功");
            })
            .catch(() => {
                this.$message.error("删除失败");
            })
        })
    }
```

entity包下新建SpecParamEntity

dto包下新建SpecParamDTO

在SpecificationService中写接口

mapper包下新建SpecParamMapper

SpecificationServiceImpl

接口

```js
	@ApiOperation(value = "新增规格参数")
    @PostMapping(value = "/specparam/save")
    Result<JSONObject> saveSpecParam(@RequestBody SpecParamDTO specParamDTO);

    @ApiOperation(value = "修改规格参数")
    @PutMapping(value = "/specparam/save")
    Result<JSONObject> updateSpecParam(@RequestBody SpecParamDTO specParamDTO);

    @ApiOperation(value = "删除规格参数")
    @DeleteMapping(value = "/specparam/delete")
    Result<JSONObject> deleteSpecParam(Integer id);
```



```
//查询规格参数 通过id查询
SpecParamEntity specParamEntity = BaiduBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class);
        Example example = new Example(SpecParamEntity.class);
        example.createCriteria().andEqualTo("groupId",specParamEntity.getGroupId());

        List<SpecParamEntity> list = specParamMapper.selectByExample(example);
        //返回给前台
        return this.setResultSuccess(list);
```

规格参数 新增 修改 删除

```
public Result<JSONObject> saveSpecParam(SpecParamDTO specParamDTO) {
        specParamMapper.insertSelective(BaiduBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class));
        return this.setResultSuccess();
    }
```

修改

```
 specParamMapper.updateByPrimaryKey(BaiduBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class));
        return this.setResultSuccess();
```

删除

```
specParamMapper.deleteByPrimaryKey(id);
        return this.setResultSuccess();
```

## !!!安装FastDFS!!!

每次重启腾讯云 也需要重启Linux中的 service fdfs_trackerd start   service fdfs_storaged start  nginx

需要进入安装service fdfs_trackerd start   service fdfs_storaged start  nginx的目录下面输入重启

如果安装出现错误 需要重装系统重新安装 !!!!

启动tracker

```
service fdfs_trackerd start #停止换成stop
```

启动storage

```
service fdfs_storaged start
```

启动nginx

```
nginx
nginx -s stop #停止
nginx -s reload #重新加载配置
```

## 商品列表

更改前台value值 0为下架 1为上架 2为全部

Goods.vue  line:8

```js
<v-btn-toggle mandatory v-model="search.saleable">
<!--将此处改为number类型的值比较好处理-->
<v-btn flat :value="2">
全部
</v-btn>
<v-btn flat :value="1">
上架
</v-btn>
<v-btn flat :value="0">
下架
</v-btn>
</v-btn-toggle>
```

前台vue实现分页和搜索功能

SpuEntity

```
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

/**
 * @ClassName SpuEntity
 * @Description: TODO
 * @Author hlmb
 * @Date 2021/1/5
 * @Version V1.0
 **/
@Table(name = "tb_spu")
@Data
public class SpuEntity {

    @Id
    private Integer id;

    private String title;

    private String subTitle;

    private Integer cid1;

    private Integer cid2;

    private Integer cid3;

    private Integer brandId;

    private Integer saleable;

    private Integer valid;

    private Date createTime;

    private Date lastUpdateTime;
}
```

SpuDTO

```
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;
import java.util.Date;

/**
 * @ClassName SpuDTO
 * @Description: TODO
 * @Author hlmb
 * @Date 2021/1/5
 * @Version V1.0
 **/
@ApiModel(value = "spu数据传输DTO")
@Data
public class SpuDTO extends BaseDTO {

    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "标题")
    @NotEmpty(message = "标题不能为空",groups = {MingruiOperation.Add.class})
    private String title;

    @ApiModelProperty(value = "子标题")
    private String subTitle;

    @ApiModelProperty(value = "1级类目id",example = "1")
    @NotNull(message = "1级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid1;

    @ApiModelProperty(value = "1级类目id",example = "1")
    @NotNull(message = "2级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid2;

    @ApiModelProperty(value = "1级类目id",example = "1")
    @NotNull(message = "3级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid3;

    @ApiModelProperty(value = "商品所属品牌id",example = "1")
    @NotNull(message = "商品所属id不能为空",groups = {MingruiOperation.Add.class})
    private Integer brandId;

    //不需要验证
    @ApiModelProperty(value = "是否上架,1上架,0下架",example = "1")
    private Integer saleable;

    //不需要验证
    @ApiModelProperty(value = "是否有效,1有效,0无效",example = "1")
    private Integer valid;

    //不需要验证
    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    //不需要验证
    @ApiModelProperty(value = "最后修改时间")
    private Date lastUpdateTime;

}
```



### 商品查询

line：204

```
getDataFromApi() {
        this.loading = true;
        this.$http.get("/goods/getSpuInfo",{
          params:{
            page:this.pagination.page,
            rows:this.pagination.rowsPerPage,
            sort:this.pagination.sortBy,
            order:this.pagination.descending,
            saleable:this.search.saleable,
            title:this.search.key
          },
        }).then((resp) =>{
          this.items = resp.data.data.list;
          this.totalItems = resp.data.data.total;
          this.loading = false;
        }).catch(error => console.log(error))
```

后台接口

```
@Api(tags = "商品接口")
public interface GoodsService {
    @ApiOperation(value = "获取spu信息")
    @GetMapping(value = "/goods/getSpuInfo")
    Result<List<SpuEntity>> getSpuInfo(SpuDTO spuDTO);
}
```

查询分页 是否上架 模糊查询 

```
		//分页
        if(ObjectUtil.isNotNull(spuDTO.getPage()) && ObjectUtil.isNotNull(spuDTO.getRows()))
            PageHelper.startPage(spuDTO.getPage(),spuDTO.getRows());

        Example example = new Example(SpuEntity.class);
        Example.Criteria criteria = example.createCriteria();

        //是否上架
        if(ObjectUtil.isNotNull(spuDTO.getSaleable()) && spuDTO.getSaleable() < 2)
            criteria.andEqualTo("saleable",spuDTO.getSaleable());
        //模糊查询
        if(!StringUtils.isEmpty(spuDTO.getTitle()))
            criteria.andLike("title","%" + spuDTO.getTitle() + "%");

        List<SpuEntity> spuEntities = spuMapper.selectByExample(example);
        PageInfo<SpuEntity> spuEntityPageInfo = new PageInfo<>(spuEntities);
        
        return this.setResultSuccess(spuEntityPageInfo);
```

查询品牌 和 商品分类

```
 List<SpuDTO> spuDTOList =spuEntities.stream().map(spuEntity -> {
            //调用BaiduUtil工具包
            SpuDTO spuDTO1 = BaiduBeanUtil.copyProperties(spuEntity, SpuDTO.class);

            //通过cid 查询数据
            List<CategoryEntity> categoryEntities = categoryMapper.selectByIdList(Arrays.asList(spuEntity.getCid1(), spuEntity.getCid2(), spuEntity.getCid3()));

            //查询商品分类
            String categoryName = categoryEntities.stream().map(categoryEntity -> categoryEntity.getName()).collect(Collectors.joining("/"));
            spuDTO1.setCategoryName(categoryName);

            //查询品牌
            BrandEntity brandEntity = brandMapper.selectByPrimaryKey(spuEntity.getBrandId());
            spuDTO1.setBrandName(brandEntity.getName());

            return spuDTO1;
        }).collect(Collectors.toList());

        PageInfo<SpuEntity> spuEntityPageInfo = new PageInfo<>(spuEntities);
        return this.setResult(HTTPStatus.OK,spuEntityPageInfo.getTotal() + "",spuDTOList);

    }
```

### 商品新增

没有提交后台代码 只是写了 前台代码

修改前台代码 将vue改为和自己后台一样的接口 

 GoodsFrom.vue line:20 

```
        <!--商品分类-->
        <v-cascader
        url="/category/list"
        required
        showAllLevels
        v-model="goods.categories"
        label="请选择商品分类"/>
```

line:277

```
        handler(val) {
        	// 判断商品分类是否存在，存在才查询
        	if (val && val.length > 0) {
       		 // 根据分类查询品牌
       		 this.$http
        		.get("brand/getBrandByCategory",{
        		  params:{
       				 cid:this.goods.categories[2].id
            	}
       	 })
            .then((resp) => {
            this.brandOptions = resp.data.data;
            });
        // 根据分类查询规格参数
        this.$http
       	 .get("/specparam/getSpecParamInfo",{
       		 params:{
        		cid:this.goods.categories[2].id
       	 	}
       	 })
        .then(( resp ) => {
            let specs = [];
            let template = [];
            if (this.isEdit){
            specs = JSON.parse(this.goods.spuDetail.genericSpec);
            template = JSON.parse(this.goods.spuDetail.specialSpec);
        }
        // 对特有规格进行筛选
        const arr1 = [];
        const arr2 = [];
        resp.data.data.forEach(({id, name,generic, numeric, unit }) => {
            if(generic){
            const o = { id, name, numeric, unit};
            if(this.isEdit){
            o.v = specs[id];
            }
        		arr1.push(o)
        	}else{
       		 const o = {id, name, options:[]};
        		if(this.isEdit){
        	o.options = template[id];
       	 }
            	arr2.push(o)
              }
            });
                    this.specs = arr1;// 通用规格
                    this.specialSpecs = arr2;// 特有规格
                });
            }
        }
```

 Editor.vue   line:93

```
        this.$http.post(this.uploadUrl, data)
            .then(resp => {
            	//修改图片回显的路径
                if (resp.data.data) {
                this.editor.insertEmbed(this.editor.getSelection().index, 'image',
                resp.data.data)
            }
        })

```

后台增加一条查询语句在BrandEntity中

```
@Select(value = "select * from tb_brand b where b.id in(select cb.brand_id from tb_category_brand cb where cb.category_id=#{cid})")
    List<BrandEntity> getBrandInfoByCategoryId(Integer cid);
```

在BrandService中写接口

```
@GetMapping(value = "brand/getBrandInfoByCategoryId")
@ApiOperation(value = "通过id分类查询品牌")
Result<List<BrandEntity>> getBrandInfoByCategoryId(Integer cid);
```

在BrandServiceImpl中

```
@Override
public Result<List<BrandEntity>> getBrandInfoByCategoryId(Integer cid) {
    List<BrandEntity> list = brandMapper.getBrandInfoByCategoryId(cid);
    return this.setResultSuccess(list);
}
```

然后再SpecificationServiceImpl中增加两个if判断 这样页面中的增加 的所有功能都可以填完

```
@Override
public Result<List<SpecParamEntity>> getSpecParamInfo(SpecParamDTO specParamDTO) {
    SpecParamEntity specParamEntity = BaiduBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class);
    Example example = new Example(SpecParamEntity.class);
    Example.Criteria criteria = example.createCriteria();

    if(ObjectUtil.isNotNull(specParamEntity.getGroupId()));
    criteria.andEqualTo("groupId",specParamEntity.getGroupId());

    if(ObjectUtil.isNotNull(specParamEntity.getCid()));
        criteria.andEqualTo("cid",specParamEntity.getCid());

        List<SpecParamEntity> list = specParamMapper.selectByExample(example);
    return this.setResultSuccess(list);
}
```

新增后台

GoodsService

```
@ApiOperation(value = "商品新增")
@PostMapping(value = "/goods/save")
Result<JSONObject> save(@RequestBody SpuDTO spuDTO);
```

GoodsServiceImpl

```
@Override
public Result<JSONObject> save(SpuDTO spuDTO) {

    final Date date = new Date();

    //新增主键
    SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO, SpuEntity.class);
    spuEntity.setSaleable(1);
    spuEntity.setValid(1);
    spuEntity.setCreateTime(date);
    spuEntity.setLastUpdateTime(date);
    spuMapper.insertSelective(spuEntity);

    //新增spuDetail
    SpuDetailDTO spuDetail = spuDTO.getSpuDetail();
    SpuDetailEntity spuDetailEntity = BaiduBeanUtil.copyProperties(spuDetail, SpuDetailEntity.class);
    spuDetailEntity.setSpuId(spuDetail.getSpuId());
    spuDetailMapper.insertSelective(spuDetailEntity);

    //新增sku
    List<SkuDTO> skus = spuDTO.getSkus();
    skus.stream().forEach(skuDTO -> {
        SkuEntity skuEntity = BaiduBeanUtil.copyProperties(skuDTO, SkuEntity.class);
        skuEntity.setSpuId(spuEntity.getId());
        skuEntity.setCreateTime(date);
        skuEntity.setLastUpdateTime(date);
        skuMapper.insertSelective(skuEntity);

    //新增stock
        StockEntity stockEntity = new StockEntity();
        stockEntity.setSkuId(skuEntity.getId());
        stockEntity.setStock(skuDTO.getStock());
        stockMapper.insertSelective(stockEntity);
    });

    return this.setResultSuccess();
}
```

### 商品修改(传参回显)

修改前台

Goods.vue

```
editItem(item) {
//弹出模态框,页面bug,理论上不应该这么做
this.isEdit = true;
this.show = true;
//不能直接给this.selectedGoods赋值,在这赋值以后GoodsForm会监控到oldGoods发生变化
了
// this.selectedGoods = item;
// const names = item.categoryName.split("/");
// this.selectedGoods.categories = [
// { id: item.cid1, name: names[0] },
// { id: item.cid2, name: names[1] },
// { id: item.cid3, name: names[2] },
// ];
//列表中传输过来的数据
let obj = item;
// 查询商品详情
this.$http
.get("/goods/getSpuDetailBydSpu", {
params: {
spuId: item.id,
},
})
.then((resp) => {
//准备分类需要回显的数据
obj.categories = [];//解决子级组件监控undefiend问题
//商品详情
obj.spuDetail = resp.data.data;
//特殊规格数据
obj.spuDetail.specTemplate = resp.data.specialSpec;
//通用规格数据
obj.spuDetail.specifications = resp.data.genericSpec;
//查询sku
    this.$http
        .get("goods/getSkuBySpuId", {
         params: {
         spuId: item.id,
        },
        })
      .then((resp) => {
     obj.skus = resp.data.data;
    //需要回显的数据
    this.selectedGoods = obj;//最后再给selectedGoods赋值
    })
    .catch((error) => console.log(error));
    });
},

```

 GoodsForm.vue

```
//监控需要回显的数据
oldGoods: {
    deep: true,
    handler(val) {
    //新增,清空数据
    if (!this.isEdit) {
        Object.assign(this.goods, {
        categories: null, // 商品分类信息
        brandId: 0, // 品牌id信息
        title: "", // 标题
        subTitle: "", // 子标题
            spuDetail: {
            packingList: "", // 包装列表
            afterService: "", // 售后服务
            description: "" // 商品描述
    }
});
	this.specs = [];
	this.specialSpecs = [];
    } else {//修改
    //深拷贝?????深拷贝与浅拷贝的区别
    this.goods = Object.deepCopy(val);
    // 先得到分类名称 bug我们获取到的是categoryName
    const names = val.categoryName.split("/");
    // 组织商品分类数据
    setTimeout(() => {
    this.goods.categories = [
    { id: val.cid1, name: names[0] },
    { id: val.cid2, name: names[1] },
    { id: val.cid3, name: names[2] }
    ];
		},100);
	// 将skus处理成map
        const skuMap = new Map();
        this.goods.skus.forEach(s => {
        skuMap.set(s.indexes, s);
	});
    this.goods.skus = skuMap;
    }
   }
},
    "goods.categories": {
    deep: true,
    handler(val) {
    // 判断商品分类是否存在，存在才查询
    if (val && val.length > 0) {
    // 根据分类查询品牌
    this.$http
    .get("brand/getBrandByCategory",{
    params:{
    cid:this.goods.categories[2].id
    }
    })
    .then((resp) => {
    this.brandOptions = resp.data.data;
    });
    // 根据分类查询规格参数
    this.$http
    .get("/specparam/getSpecParamInfo",{
    params:{
    cid:this.goods.categories[2].id
    }
    })
        .then(( resp ) => {
        let specs = [];
        let template = [];
        if (this.isEdit){
    specs = JSON.parse(this.goods.spuDetail.genericSpec);
    template = JSON.parse(this.goods.spuDetail.specialSpec);
    }
        // 对特有规格进行筛选
        const arr1 = [];
        const arr2 = [];
        resp.data.data.forEach(({id, name,generic, numeric, unit }) => {
        if(generic){
        const o = { id, name, numeric, unit};
        if(this.isEdit){
        o.v = specs[id];
        }
        arr1.push(o)
        }else{
        const o = {id, name, options:[]};
        if(this.isEdit){
        o.options = template[id];
        	}
        	arr2.push(o)
       	  }
        });
            this.specs = arr1;// 通用规格
            this.specialSpecs = arr2;// 特有规格
        });
        }
    }
}
```

后台

GoodsService

```
@ApiOperation(value = "获取spu详情信息")
@GetMapping(value = "goods/getSpuDetailBydSpu")
public Result<SpuDetailEntity> getSpuDetailBydSpu(Integer spuId);
@ApiOperation(value = "获取sku信息")
@GetMapping(value = "goods/getSkuBySpuId")
Result<List<SkuDTO>>getSkuBySpuId(Integer spuId);
```

SpuDTO中加两个字段

```
@ApiModelProperty(value = "大字段数据")
private SpuDetailDTO spuDetail;

@ApiModelProperty(value = "sku属性数据集合")
private List<SkuDTO> skus;
```

SkuMapper写查询语句

```
@Select(value = "select k.*,stock from tb_sku k , tb_stock t where k.id =t.sku_id and k.spu_id=#{spuId}")
List<SkuDTO> selectSkuAndStockBySpuId(Integer spuId);
```

 GoodsServiceImpl查询数据修改id

```
    @Override
    public Result<SpuDetailEntity> getSpuDetailBydSpu(Integer spuId) {
    SpuDetailEntity spuDetailEntity =
    spuDetailMapper.selectByPrimaryKey(spuId);
    return this.setResultSuccess(spuDetailEntity);
    }
    @Override
    public Result<List<SkuDTO>> getSkuBySpuId(Integer spuId) {
    List<SkuDTO> list = skuMapper.selectSkuAndStockBySpuId(spuId);
    return this.setResultSuccess(list);
    }

```

后台

GoodsForm.vue

```
    this.$http({
        method: this.isEdit ? "put" : "post",
            url: "/goods/save",
            data: goodsParams
    })

```

商品修改(后台数据)

GoodsService

```
@ApiOperation(value = "修改商品")
@PutMapping(value = "goods/save")
Result<JSONObject> editGoods(@RequestBody SpuDTO spuDTO);
```

GoodsServiceImpl

```
@Override
public Result<JSONObject> editGoods(SpuDTO spuDTO) {
    final Date date = new Date();
    //修改spu
    SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO, SpuEntity.class);
    spuEntity.setLastUpdateTime(date);
    spuMapper.updateByPrimaryKeySelective(spuEntity);

    //修改spuDetail
    spuDetailMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(spuDTO.getSpuDetail(),SpuDetailEntity.class));

    //通过spuId查询sku信息
    this.deleteSkusAndStock(spuEntity.getId());

    this.SaveAndEtid(spuDTO,spuEntity.getId(),date);

    return this.setResultSuccess();
}
```

商品删除

```
@ApiOperation(value = "删除")
@DeleteMapping(value = "/goods/delete")
Result<JSONObject> deleteGoods(Integer spuId);
```

GoodsServiceImpl

```
@Override
public Result<JSONObject> deleteGoods(Integer spuId) {
    //删除spu
    spuMapper.deleteByPrimaryKey(spuId);
    //删除spuDetail
    spuDetailMapper.deleteByPrimaryKey(spuId);

    //删除sku
    this.deleteSkusAndStock(spuId);
    return this.setResultSuccess();
}
```

### 上架下架

```
@Override
public Result<JSONObject> shangxiajia(SpuDTO spuDTO) {
    SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO, SpuEntity.class);
    if(ObjectUtil.isNotNull(spuEntity.getSaleable()) && spuEntity.getSaleable() !=2)
        if(spuEntity.getSaleable()==1){
            spuEntity.setSaleable(0);
            spuMapper.updateByPrimaryKeySelective(spuEntity);
            return this.setResultSuccess("下架成功");
    }else {
        spuEntity.setSaleable(1);
        spuMapper.updateByPrimaryKeySelective(spuEntity);
        return this.setResultSuccess("上架成功");
        }
        return this.setResultError("失败");
}
```

### 提取公共代码  

新增中修改换成这个

//新增sku
this.SaveAndEtid(spuDTO,spuEntity.getId(),date);

修改 

```
@Override
public Result<JSONObject> editGoods(SpuDTO spuDTO) {
    final Date date = new Date();
    //修改spu
    SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO, SpuEntity.class);
    spuEntity.setLastUpdateTime(date);
    spuMapper.updateByPrimaryKeySelective(spuEntity);

    //修改spuDetail
    spuDetailMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(spuDTO.getSpuDetail(),SpuDetailEntity.class));

    //通过spuId查询sku信息
    this.deleteSkusAndStock(spuEntity.getId());

    this.SaveAndEtid(spuDTO,spuEntity.getId(),date);

    return this.setResultSuccess();
}
```

删除

```
private void deleteSkusAndStock (Integer spuId){
    Example example = new Example(SkuEntity.class);
    example.createCriteria().andEqualTo("spuId",spuId);
    List<SkuEntity> skuEntities = skuMapper.selectByExample(example);
    //得到skuId集合
    List<Long> skuIdList = skuEntities.stream().map(skuEntity -> skuEntity.getId()).collect(Collectors.toList());
    skuMapper.deleteByIdList(skuIdList);//通过skuId集合删除sku信息
    stockMapper.deleteByIdList(skuIdList);//通过skuId集合删除stock信息
}
```

### Elasticsearch安装

在hlmb下建立es

![image-20210108205502336](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210108205502336.png)

```
tar -zxvf elasticsearch-7.5.1-linux-x86_64.tar.gz #解压压缩包
groupadd esgroup #创建用户组
useradd esuser -g esgroup -p 123456 #在用户组下新建用户
cd elasticsearch-7.5.1/config/ #进入配置文件目录
vi jvm.options #修改JVM参数(默认1G)
Xms512m
Xmx512m
```

![image-20210108205825969](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210108205825969.png)

保存并退出

```
vi elasticsearch.yml
cluster.name: my-application #集群名称
node.name: node-1 #当前节点名称
path.data: /hlmb/es/elasticsearch-7.5.1/data #数据存放目录
path.logs: /hlmb/es/elasticsearch-7.5.1/logs #日志目录
network.host: 0.0.0.0 #允许任意ip访问
discovery.seed_hosts: ["119.45.191.248"] #所有节点ip,由于当前环境采用单节点,所以只写当前节点ip地址
cluster.initial_master_nodes: ["node-1"] #声明master节点,由于当前是单节点环境所以
master节点就是当前节点[此处可以写ip:9200也可以写node.name]
```

![image-20210108210140540](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210108210140540.png)

![image-20210108210153206](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210108210153206.png)

![image-20210108210205327](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210108210205327.png)

![image-20210108210214507](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210108210214507.png)

![image-20210108210228015](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210108210228015.png)

保存并退出

cd ../../ #进入es的上级目录

![image-20210108210313385](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210108210313385.png)

```
chown -R esuser:esgroup elasticsearch-7.5.1 #给用户授权
su esuser #切换用户
```

![image-20210108210336640](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210108210336640.png)

```
cd elasticsearch-7.5.1/bin/ #进入bin目录
./elasticsearch 启动es
```

如果上述代码出现问题

```
su root
sysctl -w vm.max_map_count=262144
sysctl -a|grep vm.max_map_count
su esuser
```

![image-20210108210452595](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210108210452595.png)

### 安装ik分词器

进入es目录下的plugins目录创建ik目录

```
mkdir ik
cd ik
```

将elasticsearch-analysis-ik-7.5.1.zip上传到ik目录

```
unzip elasticsearch-analysis-ik-7.5.1.zip #解压压缩包
```

![image-20210108210735465](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210108210735465.png)

```
rm -rf elasticsearch-analysis-ik-7.5.1.zip #删除压缩包
```

重启es

```
cd ../bin/
./elasticsearch
./elasticsearch -d #后台启动
```

### 安装kibana(可视化工具)

解压kinana

进入config文件修改kibana.yml文件

![image-20210108210955108](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210108210955108.png)

改为自己的llinux ip地址

进入bin文件

![image-20210108211052288](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210108211052288.png)

打开kibana.bat

![image-20210108211107400](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210108211107400.png)



运行黑窗口中的localhost:5601/ 进行测试